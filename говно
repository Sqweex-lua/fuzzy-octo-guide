import discord
from discord.ext import commands
import yt_dlp
import os

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TOKEN = "YOUR_BOT_TOKEN"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix='!', intents=intents)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –º—É–∑—ã–∫–∏
ytdl_opts = {
    'format': 'bestaudio/best',
    'postprocessors': [{
        'key': 'FFmpegExtractAudio',
        'preferredcodec': 'mp3',
        'preferredquality': '192',
    }],
    'outtmpl': 'music/%(title)s.%(ext)s',  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–ø–∫—É music
    'quiet': True,
    'no_warnings': True,
}

# –û—á–µ—Ä–µ–¥—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
queues = {}

@bot.event
async def on_ready():
    print(f"‚úÖ –ë–æ—Ç {bot.user} –≥–æ—Ç–æ–≤!")
    if not os.path.exists('music'):
        os.makedirs('music')

def play_next(ctx, error=None):
    """–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫ –∏–∑ –æ—á–µ—Ä–µ–¥–∏"""
    guild_id = ctx.guild.id
    if guild_id in queues and queues[guild_id]:
        next_file = queues[guild_id].pop(0)
        source = discord.FFmpegPCMAudio(executable="ffmpeg", source=next_file)
        ctx.voice_client.play(source, after=lambda e: play_next(ctx, e))
        
@bot.command()
async def join(ctx):
    """–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –≥–æ–ª–æ—Å–æ–≤–æ–º—É –∫–∞–Ω–∞–ª—É"""
    if ctx.author.voice:
        await ctx.author.voice.channel.connect()
        await ctx.send("‚úÖ –ü–æ–¥–∫–ª—é—á–∏–ª—Å—è!")
    else:
        await ctx.send("‚ùå –í–æ–π–¥–∏—Ç–µ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª!")

@bot.command()
async def play(ctx, *, url):
    """–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –º—É–∑—ã–∫—É —Å YouTube"""
    if not ctx.author.voice:
        return await ctx.send("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª!")
    
    if not ctx.voice_client:
        await ctx.author.voice.channel.connect()
    
    await ctx.send("‚è¨ –°–∫–∞—á–∏–≤–∞—é...")
    
    # –°–∫–∞—á–∏–≤–∞–µ–º –º—É–∑—ã–∫—É
    with yt_dlp.YoutubeDL(ytdl_opts) as ydl:
        info = ydl.extract_info(url, download=True)
        filename = ydl.prepare_filename(info).rsplit('.', 1)[0] + '.mp3'
    
    # –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
    if ctx.voice_client.is_playing():
        if ctx.guild.id not in queues:
            queues[ctx.guild.id] = []
        queues[ctx.guild.id].append(filename)
        await ctx.send(f"üéµ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å: **{info['title']}**")
    else:
        source = discord.FFmpegPCMAudio(executable="ffmpeg", source=filename)
        ctx.voice_client.play(source, after=lambda e: play_next(ctx, e))
        await ctx.send(f"üé∂ –°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç: **{info['title']}**")

@bot.command()
async def pause(ctx):
    """–ü–∞—É–∑–∞"""
    if ctx.voice_client.is_playing():
        ctx.voice_client.pause()
        await ctx.send("‚è∏Ô∏è –ü–∞—É–∑–∞")

@bot.command()
async def resume(ctx):
    """–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"""
    if ctx.voice_client.is_paused():
        ctx.voice_client.resume()
        await ctx.send("‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º")

@bot.command()
async def stop(ctx):
    """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º—É–∑—ã–∫—É"""
    if ctx.voice_client:
        ctx.voice_client.stop()
        if ctx.guild.id in queues:
            queues[ctx.guild.id].clear()
        await ctx.send("‚èπÔ∏è –ú—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")

@bot.command()
async def skip(ctx):
    """–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–µ–∫"""
    if ctx.voice_client.is_playing():
        ctx.voice_client.stop()
        await ctx.send("‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ")

@bot.command()
async def leave(ctx):
    """–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è –æ—Ç –∫–∞–Ω–∞–ª–∞"""
    if ctx.voice_client:
        await ctx.voice_client.disconnect()
        if ctx.guild.id in queues:
            del queues[ctx.guild.id]
        await ctx.send("üëã –û—Ç–∫–ª—é—á–∏–ª—Å—è")

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == "__main__":
    print("üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –±–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    print("‚ö†Ô∏è –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ FFmpeg —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ PATH")
    bot.run(TOKEN)
